function loadUtil(){loaded++;if(loaded==12){drawUnsolved();drawToolbar()}}function getImgurImages(e){$.ajax({url:"https://api.imgur.com/3/album/"+e,type:"GET",dataType:"json",cache:false,beforeSend:function(e){e.setRequestHeader("Authorization","Client-ID 60512304ac2e7ce")},success:function(e){albumURL=e.data.link;if(e.data.images.length>=9){$("#alerts").text("Loading...");for(var t=0;t<9;t++){images.push(new Image);images[t].src=e.data.images[t].link;images[t].index=t;images[t].onload=function(){loaded++;$("#alerts").append(".");if(this.width>this.height){this.divisor=this.width/75}else{this.divisor=this.height/75}if(loaded==12){$("#alerts").text("Loaded!  Enjoy your game.");if(loadedPuzzle){drawUnsolved();drawToolbar()}}}}}else{$("#insufficientImagesError").modal()}},error:function(e){$("#imgurMalformedError").modal()}})}function getFBAlbum(e){(function(e){var t,n="facebook-jssdk",r=e.getElementsByTagName("script")[0];if(e.getElementById(n)){return}t=e.createElement("script");t.id=n;t.async=true;t.src="//connect.facebook.net/en_US/all.js";r.parentNode.insertBefore(t,r)})(document);window.fbAsyncInit=function(){FB.init({appId:"154174584743698",channelUrl:"/res/misc/channel.html",status:true,cookie:true,xfbml:true});FB.getLoginStatus(function(t){if(t.status==="connected"){FB.api("/"+e,function(e){document.title="Imagedoku - "+e.name+" (Facebook)";albumURL=e.link});FB.api("/"+e+"/photos",function(e){getFBImages(e)})}else if(t.status==="not_authorized"){$("#fbUnauthorizedError").modal()}else{$("#fbLoggedOutError").modal()}})}}function getFBImages(e){if(e.data.length>=9){$("#alerts").text("Loading...");for(var t=0;t<9;t++){images.push(new Image);images[t].src=e.data[t].source;images[t].index=t;images[t].onload=function(){loaded++;$("#alerts").append(".");if(this.width>this.height){this.divisor=this.width/75}else{this.divisor=this.height/75}if(loaded==12){$("#alerts").text("Loaded!  Enjoy your game.");if(loadedPuzzle){drawUnsolved();drawToolbar()}}}}}else{$("#insufficientImagesError").modal()}}function drawUnsolved(){stage.clear();imgLayer.removeChildren();cellLayer.removeChildren();miniCellLayer.removeChildren();backCellLayer.removeChildren();for(var e=0;e<9;e++){for(var t=0;t<9;t++){if(board.tiles[e][t].val!="."&&board.tiles[e][t].val!="*"){imageSrc=images[board.tiles[e][t].val-1];var n;if(drawImg){n=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor),width:Math.floor(imageSrc.width/imageSrc.divisor),x:Math.floor(75*e+10*(Math.floor(e/3)+1)+2*(e+1)+2*e+(75-imageSrc.width/imageSrc.divisor)/2),y:Math.floor(75*t+10*(Math.floor(t/3)+1)+2*(t+1)+2*t+(75-imageSrc.height/imageSrc.divisor)/2)})}else if(!drawImg){n=new Kinetic.Text({x:Math.floor(75*e)+10*(Math.floor(e/3)+1)+2*(e+1)+2*e,y:Math.floor(75*t)+10*(Math.floor(t/3)+1)+2*(t+1)+2*t,fontFamily:"Liberation",text:board.tiles[e][t].val,fontSize:75,fill:"black",height:75,width:75,align:"center"})}imgLayer.add(n)}else if(board.tiles[e][t].val=="*"){for(k in board.tiles[e][t].poss){if(board.tiles[e][t].poss[k]){imageSrc=images[k];var r,i;r=75*e+10*(Math.floor(e/3)+1)+2*(e+1)+2*e;i=75*t+10*(Math.floor(t/3)+1)+2*(t+1)+2*t;r+=k%3*25;i+=Math.floor(k/3)*25;var n;if(drawImg){var s=Math.floor((25-imageSrc.width/imageSrc.divisor/3)/2);var o=Math.floor((25-imageSrc.height/imageSrc.divisor/3)/2);r+=s;i+=o;r=Math.floor(r);i=Math.floor(i);n=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor/3),width:Math.floor(imageSrc.width/imageSrc.divisor/3),x:r,y:i})}else if(!drawImg){var u=Number(k)+1;r=Math.floor(r);i=Math.floor(i);n=new Kinetic.Text({fontFamily:"Liberation",height:Math.floor(75/3),width:Math.floor(75/3),fontSize:25,text:u,x:r,y:i,align:"center",fill:"black"})}imgLayer.add(n)}}}}}drawTiles();stage.draw()}function drawTiles(){for(var e=0;e<3;e++){for(var t=0;t<3;t++){var n=new Kinetic.Rect({x:Math.floor(242*e)+5*(e+1),y:Math.floor(242*t)+5*(t+1),width:247,height:247,stroke:"black",strokeWidth:10});backCellLayer.add(n)}}for(var e=0;e<9;e++){for(var t=0;t<9;t++){if(board.tiles[e][t].val=="*"){for(var r=0;r<3;r++){for(var i=0;i<3;i++){var n=new Kinetic.Rect({X:Math.floor(75*e+r*25)+10*(Math.floor(e/3)+1)+2*(e+1)+2*e,y:Math.floor(75*t+i*25)+10*(Math.floor(t/3)+1)+2*(t+1)+2*t,width:25,height:25,stroke:"black",strokeWidth:1});miniCellLayer.add(n)}}}var s,o;if(board.tiles[e][t].conf==3){s="green";o=4}else if(board.tiles[e][t].conf==2){s="yellow";o=4}else if(board.tiles[e][t].conf==1){s="red";o=4}else if(board.tiles[e][t].conf==0){s="black";o=4}var n=new Kinetic.Rect({x:Math.floor(75*e)+10*(Math.floor(e/3)+1)+2*(e+1)+2*e,y:Math.floor(75*t)+10*(Math.floor(t/3)+1)+2*(t+1)+2*t,width:75,height:75,stroke:s,strokeWidth:4});n.ix=e;n.iy=t;n.on("mouseover",function(){mousedOver={x:this.ix,y:this.iy}});if(!board.tiles[e][t].perm){n.on("mouseover",function(){this.setStroke("rgb(145, 253, 255)");this.setStrokeWidth(4);this.moveToTop();stage.draw()});if(board.tiles[e][t].conf==3){n.on("mouseout",function(){this.setStroke("green");this.setStrokeWidth(4);this.moveToBottom();stage.draw()})}else if(board.tiles[e][t].conf==2){n.on("mouseout",function(){this.setStroke("yellow");this.setStrokeWidth(4);this.moveToBottom();stage.draw()})}else if(board.tiles[e][t].conf==1){n.on("mouseout",function(){this.setStroke("red");this.setStrokeWidth(4);this.moveToBottom();stage.draw()})}else{n.on("mouseout",function(){this.setStroke("black");this.setStrokeWidth(4);this.moveToBottom();stage.draw()})}}n.on("click tap",function(e){if(e.which==1)selectTile(this.ix,this.iy,true);else if(e.which==3)selectTile(this.ix,this.iy,false)});cellLayer.add(n)}}}function drawToolbar(){imgToolLayer.removeChildren();cellToolLayer.removeChildren();for(var e=0;e<9;e++){imageSrc=images[e];var t=2;var n=e;n*=75;n+=4*e+2+20;var r;if(drawImg){r=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor),width:Math.floor(imageSrc.width/imageSrc.divisor),x:Math.floor(t+(75-imageSrc.width/imageSrc.divisor)/2),y:Math.floor(n+(75-imageSrc.height/imageSrc.divisor)/2)})}else if(!drawImg){r=new Kinetic.Text({x:t,y:n,fontFamily:"Liberation",text:e+1,fontSize:75,fill:"black",height:75,width:75,align:"center"})}imgToolLayer.add(r)}for(var e=0;e<9;e++){var i,s;if(e+1==selected){i="rgb(145, 253, 255)";s=4}else{i="black";s=4}var o=new Kinetic.Rect({x:2,y:Math.floor(e*75)+4*e+2+20,width:75,height:75,stroke:i,strokeWidth:s});o.val=e+1;o.on("click",function(){selectTool(this.val);drawToolbar()});cellToolLayer.add(o)}var r=new Kinetic.Image({image:erase,height:75,width:75,x:75+6,y:375+22+20});imgToolLayer.add(r);var i,s;if("."==selected){i="blue";s=4}else{i="black";s=4}var o=new Kinetic.Rect({x:75+6,y:375+22+20,width:75,height:75,stroke:i,strokeWidth:s});o.val=".";o.on("click",function(){selectTool(this.val);drawToolbar()});cellToolLayer.add(o);numStage.draw();var r=new Kinetic.Image({image:zoomIn,height:75,width:75,x:75+6,y:225+14+20});imgToolLayer.add(r);var i,s;if("+"==selected){i="blue";s=4}else{i="black";s=4}var o=new Kinetic.Rect({x:75+6,y:225+14+20,width:75,height:75,stroke:i,strokeWidth:s});o.val="+";o.on("click",function(){selectTool(this.val);drawToolbar()});cellToolLayer.add(o);numStage.draw();var r=new Kinetic.Image({image:zoomOut,height:75,width:75,x:75+6,y:300+18+20});imgToolLayer.add(r);var i,s;if("-"==selected){i="blue";s=4}else{i="black";s=4}var o=new Kinetic.Rect({x:75+6,y:300+18+20,width:75,height:75,stroke:i,strokeWidth:s});o.val="-";o.on("click",function(){selectTool(this.val);drawToolbar()});cellToolLayer.add(o);numStage.draw()}function help(e){if(e){$("#help").modal({overlayClose:true})}else{$.modal.close()}}function Board(){this.tiles=[];this.solved=false;for(var e=0;e<9;e++){this.tiles[e]=[];for(var t=0;t<9;t++){if(unsolved[e][t]!="."){this.tiles[e][t]=new Tile(unsolved[e][t],solved[e][t],true)}else{this.tiles[e][t]=new Tile(unsolved[e][t],solved[e][t],false)}}}this.check=function(){var e=0;var t=0;for(var n=0;n<9;n++){for(var r=0;r<9;r++){if(this.tiles[n][r].val!=this.tiles[n][r].sol&&this.tiles[n][r].val!="."&&this.tiles[n][r].val!="*"){this.tiles[n][r].conf=1;t++}else if(this.tiles[n][r].val=="."||this.tiles[n][r].val=="*"){e++}else{if(!this.tiles[n][r].perm)this.tiles[n][r].conf=3}}}drawUnsolved();return{b:e,e:t}};this.solve=function(){for(var e=0;e<9;e++){for(var t=0;t<9;t++){if(!this.tiles[e][t].perm){this.tiles[e][t].val=this.tiles[e][t].sol;this.tiles[e][t].conf=3}}}drawUnsolved();this.checkWin()};this.checkWin=function(){var e=0;var t=0;for(var n=0;n<9;n++){for(var r=0;r<9;r++){if(this.tiles[n][r].val!=this.tiles[n][r].sol&&this.tiles[n][r].val!="."&&this.tiles[n][r].val!="*"){t++}else if(this.tiles[n][r].val=="."||this.tiles[n][r].val=="*"){e++}}}if(e==0&&t==0){$("#alerts").text("We have a winner!");this.solved=true;victory=new Kinetic.Layer;victory.setClearBeforeDraw(false);stage.add(victory);for(n in images){var i=new Kinetic.Image({x:Math.floor(Math.random()*675),y:-75,height:Math.floor(images[n].height/images[n].divisor),width:Math.floor(images[n].width/images[n].divisor),image:images[n]});i.dx=Math.random()*10-5;i.dy=Math.random()*10-5;victoryDancers.push(i);victory.add(i)}window.setInterval(function(){for(n in victoryDancers){victoryDancers[n].setX(victoryDancers[n].dx+victoryDancers[n].getX());victoryDancers[n].dy+=.14;victoryDancers[n].setY(victoryDancers[n].dy+victoryDancers[n].getY());if(victoryDancers[n].getX()<-74){victoryDancers[n].setX(675)}if(victoryDancers[n].getX()>675){victoryDancers[n].setX(-75)}if(victoryDancers[n].getY()>675){victoryDancers[n].setY(-75);victoryDancers[n].dy=Math.random()*10-5}}victory.draw()},33)}};this.set=function(e,t,n,r){if(!this.solved){this.tiles[e][t].set(n,r);this.checkWin()}}}function Tile(e,t,n){this.val=e;this.poss=[];this.sol=t;this.perm=n;this.conf=0;this.resetPoss=function(){for(var e=0;e<9;e++){this.poss[e]=false}};this.set=function(e,t){if(this.perm==false){if(e=="."){this.val=e;this.conf=0;this.resetPoss()}else if(!t){if(this.poss[e-1]){this.poss[e-1]=false;var n=true;for(i in this.poss){if(this.poss[i]){n=false;i=this.poss.length}}if(n){this.val=".";this.conf=0}}else{this.poss[e-1]=true;this.val="*";this.conf=2}}else{if(this.val==e){this.resetPoss();this.val=".";this.conf=0}else{this.val=e;this.conf=2;this.resetPoss()}}drawUnsolved()}}}function selectTile(e,t,n){if(selected=="+"){zoom(e,t,true)}else if(selected=="-"){zoom(e,t,false)}else{board.set(e,t,selected,n)}}function selectTool(e){selected=e}function zoom(e,t,n){var r=stage.getScale();if(n){if(r.x<9){stage.setScale(r.x*3)}}else if(!n){if(r.x>1){stage.setScale(r.x/3)}}r=stage.getScale();if(r.x>1){if(r.x==3){stage.setX(-Math.floor(e/3)*3*75*r.x-Math.floor(e/3)*75);stage.setY(-Math.floor(t/3)*3*75*r.x-Math.floor(t/3)*75);if(Math.floor(e/3)==0){stage.setX(stage.getX()-10)}else if(Math.floor(e/3)==2){stage.setX(stage.getX()+10)}if(Math.floor(t/3)==0){stage.setY(stage.getY()-10)}else if(Math.floor(t/3)==2){stage.setY(stage.getY()+10)}}else{stage.setX(-79*e*9-79+ -10*Math.floor(e/3)*9+10);stage.setY(-79*t*9-79+ -10*Math.floor(t/3)*9+10)}}else{stage.setX(0);stage.setY(0)}stage.draw()}function checkErrors(){var e=board.check();var t="You have "+e.e+" error";if(e.e!=1){t+="s"}t+=" and "+e.b+" blank cell";if(e.b!=1){t+="s"}t+=".";$("#alerts").text(t)}function toggleDrawImg(){if(drawImg){drawImg=false;$("#toggleDrawImg").text("Switch to Images")}else{drawImg=true;$("#toggleDrawImg").text("Switch to Numbers")}drawUnsolved();drawToolbar()}function hint(){}function solvePuzzle(e){if(e){$.modal.close();board.solve()}else{$("#solvePuzzleConfirmation").modal({overlayClose:true})}}function viewAlbum(){var e=window.open(albumURL,"_blank");e.focus()}function shareAlbum(){var e="/share.html?h="+hash;var t=window.open(e,"_blank");t.focus()}function openCheckpoints(){$("#checkpoints").html("");for(i in checkpoints){var e=JSON.parse(checkpoints[i]);$("#checkpoints").prepend(drawCheckpoint(e,i))}$("#checkpointHolder").modal({overlayClose:true,onShow:function(){$("#simplemodal-container").css("height","auto");$("#simplemodal-container").css("width","auto")},onClose:function(){selectedCP=null;$.modal.close()},autoResize:true})}function setCheckpoint(){checkpoints.push(JSON.stringify(board))}function drawCheckpoint(e,t){var n='<div class="cpHolder" id="'+t+'" onclick="selectCP('+t+');">';n+='<table class="cp">';for(var r=0;r<9;r++){n+='<tr class="cp">';for(var i=0;i<9;i++){n+='<td class="cp';if(r==0||r==3||r==6){n+=" outlineTop"}else if(r==2||r==5||r==8){n+=" outlineBot"}if(i==0||i==3||i==6){n+=" outlineLeft"}else if(i==2||i==5||i==8){n+=" outlineRight"}n+='">'+e.tiles[i][r].val+"</td>"}n+="</tr>"}n+="</table>";n+="</div>";return n}function selectCP(e){if(selectedCP!=null)$("#"+selectedCP).css("background-color","transparent");selectedCP=e;$("#"+selectedCP).css("background-color","rgb(145, 253, 255)")}function retrieveCP(){var e=JSON.parse(checkpoints[selectedCP]);for(i in board.tiles){for(j in board.tiles){board.tiles[i][j].val=e.tiles[i][j].val;board.tiles[i][j].poss=e.tiles[i][j].poss;board.tiles[i][j].sol=e.tiles[i][j].sol;board.tiles[i][j].perm=e.tiles[i][j].perm;board.tiles[i][j].conf=e.tiles[i][j].conf}}board.solved=e.solved;$.modal.close();drawUnsolved()}function deleteCP(){checkpoints.splice(selectedCP,1);$.modal.close()}var stage;var numStage;var imgLayer;var backCellLayer;var miniCellLayer;var cellLayer;var victory;var imgToolLayer;var cellToolLayer;var images=[];var loaded=0;var loadedPuzzle=false;var victoryDancers=[];var erase;var zoomIn;var zoomOut;var diff;var hash;var origin;var mess;var solved=[];var unsolved=[];var board;var checkpoints=[];var selected=1;var drawImg=true;var albumURL;var mousedOver={x:null,y:null};var debug=false;window.oncontextmenu=function(){return debug};$(document).keypress(function(e){switch(Number(e.which)){case 48:selectTool(".");break;case 46:selectTool(".");break;case 49:selectTool(1);break;case 50:selectTool(2);break;case 51:selectTool(3);break;case 52:selectTool(4);break;case 53:selectTool(5);break;case 54:selectTool(6);break;case 55:selectTool(7);break;case 56:selectTool(8);break;case 57:selectTool(9);break;case 43:selectTool("+");break;case 61:selectTool("+");break;case 45:selectTool("-");break;case 95:selectTool("-");break}drawToolbar()});$(document).ready(function(){stage=new Kinetic.Stage({container:"gameStage",width:751,height:751});numStage=new Kinetic.Stage({container:"numStage",width:158,height:751});if(typeof specHash!=="undefined"){hash=specHash}else if(typeof getUrlVars()["h"]!=="undefined"){hash=getUrlVars()["h"]}else{hash="6EsqA"}if(typeof specOrigin!=="undefined"){origin=specOrigin}else if(typeof getUrlVars()["o"]!=="undefined"){origin=getUrlVars()["o"]}else{origin="i"}if(typeof specDiff!=="undefined"){diff=specDiff}else if(typeof getUrlVars()["d"]!=="undefined"){diff=getUrlVars()["d"]}else{diff=2}if(typeof specMess!=="undefined"){mess=specMess}else if(typeof getUrlVars()["pn"]!=="undefined"){if(getUrlVars()["pn"]==1){$.get("/_static/pn/pnm.txt",function(e){$("#announceWrapper").html(e);$("#announceWrapper").css("padding-bottom","20px")})}mess=-1}else{mess=-1}if(typeof getUrlVars()["debug"]!=="undefined"){if(getUrlVars()["debug"]==1){debug=true}}else{debug=false}if(mess!=-1){$("#announceWrapper").html(mess);$("#announceWrapper").css("padding-bottom","20px")}if(origin=="i"){$("#albumShare").css("display","inline");getImgurImages(hash)}else if(origin=="fb"){getFBAlbum(hash)}erase=new Image;zoomIn=new Image;zoomOut=new Image;erase.src="/res/img/erase.png";zoomIn.src="/res/img/in.png";zoomOut.src="/res/img/out.png";erase.onload=new loadUtil;zoomIn.onload=new loadUtil;zoomOut.onload=new loadUtil;imgLayer=new Kinetic.Layer;backCellLayer=new Kinetic.Layer;miniCellLayer=new Kinetic.Layer;cellLayer=new Kinetic.Layer;imgToolLayer=new Kinetic.Layer;cellToolLayer=new Kinetic.Layer;numStage.add(imgToolLayer);numStage.add(cellToolLayer);stage.add(imgLayer);stage.add(backCellLayer);stage.add(miniCellLayer);stage.add(cellLayer);var e=function(e){if(stage.getMousePosition()){e.preventDefault();if(mousedOver.x!=null&&mousedOver.y!=null){if(e.wheelDeltaY>0){zoom(mousedOver.x,mousedOver.y,true)}else if(e.wheelDeltaY<0){zoom(mousedOver.x,mousedOver.y,false)}}}};document.addEventListener("mousewheel",e,false);$.get("/res/php/puzzle.php",{d:diff}).done(function(e){var t=$.parseJSON(e);for(var n=0;n<9;n++){solved[n]=[];unsolved[n]=[];for(var r=0;r<9;r++){unsolved[n][r]=t.Unsolved.charAt(0);solved[n][r]=t.Solved.charAt(0);t.Unsolved=t.Unsolved.substr(1);t.Solved=t.Solved.substr(1)}}board=new Board;checkpoints.push(JSON.stringify(board));loadedPuzzle=true;if(loaded==12){drawUnsolved();drawToolbar()}})});var selectedCP=null