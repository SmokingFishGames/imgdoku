function loadUtil(){loaded++;if(loaded==12){drawUnsolved();drawToolbar()}}function getImgurImages(e){$.ajax({url:"https://api.imgur.com/3/album/"+e,type:"GET",dataType:"json",cache:false,beforeSend:function(e){e.setRequestHeader("Authorization","Client-ID 60512304ac2e7ce")},success:function(e){albumURL=e.data.link;if(e.data.images.length>=9){$("#alerts").text("Loading...");for(var t=0;t<9;t++){images.push(new Image);images[t].src=e.data.images[t].link;images[t].index=t;images[t].onload=function(){loaded++;$("#alerts").append(".");if(this.width>this.height){this.divisor=this.width/75}else{this.divisor=this.height/75}if(loaded==12){$("#alerts").text("Loaded!  Enjoy your game.");if(loadedPuzzle){drawUnsolved();drawToolbar()}}}}}else{$("#insufficientImagesError").modal()}},error:function(e){$("#imgurMalformedError").modal()}})}function getFBAlbum(e){(function(e){var t,n="facebook-jssdk",r=e.getElementsByTagName("script")[0];if(e.getElementById(n)){return}t=e.createElement("script");t.id=n;t.async=true;t.src="//connect.facebook.net/en_US/all.js";r.parentNode.insertBefore(t,r)})(document);window.fbAsyncInit=function(){FB.init({appId:"154174584743698",channelUrl:"/res/misc/channel.html",status:true,cookie:true,xfbml:true});FB.getLoginStatus(function(t){if(t.status==="connected"){FB.api("/"+e,function(e){document.title="Imagedoku - "+e.name+" (Facebook)";albumURL=e.link});FB.api("/"+e+"/photos",function(e){getFBImages(e)})}else if(t.status==="not_authorized"){$("#fbUnauthorizedError").modal()}else{$("#fbLoggedOutError").modal()}})}}function getFBImages(e){if(e.data.length>=9){$("#alerts").text("Loading...");for(var t=0;t<9;t++){images.push(new Image);images[t].src=e.data[t].source;images[t].index=t;images[t].onload=function(){loaded++;$("#alerts").append(".");if(this.width>this.height){this.divisor=this.width/75}else{this.divisor=this.height/75}if(loaded==12){$("#alerts").text("Loaded!  Enjoy your game.");if(loadedPuzzle){drawUnsolved();drawToolbar()}}}}}else{$("#insufficientImagesError").modal()}}function drawUnsolved(){stage.clear();imgLayer.removeChildren();cellLayer.removeChildren();miniCellLayer.removeChildren();backCellLayer.removeChildren();for(var e=0;e<9;e++){for(var t=0;t<9;t++){if(board.tiles[e][t].val!="."&&board.tiles[e][t].val!="*"){imageSrc=images[board.tiles[e][t].val-1];var n;if(drawImg){n=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor),width:Math.floor(imageSrc.width/imageSrc.divisor),x:Math.floor(75*e+(75-imageSrc.width/imageSrc.divisor)/2),y:Math.floor(75*t+(75-imageSrc.height/imageSrc.divisor)/2)})}else if(!drawImg){n=new Kinetic.Text({x:Math.floor(75*e),y:Math.floor(75*t),fontFamily:"Liberation",text:board.tiles[e][t].val,fontSize:75,fill:"black",height:75,width:75,align:"center"})}imgLayer.add(n)}else if(board.tiles[e][t].val=="*"){for(k in board.tiles[e][t].poss){if(board.tiles[e][t].poss[k]){imageSrc=images[k];var r,i;r=75*e;i=75*t;r+=k%3*25;i+=Math.floor(k/3)*25;var n;if(drawImg){var s=Math.floor((25-imageSrc.width/imageSrc.divisor/3)/2);var o=Math.floor((25-imageSrc.height/imageSrc.divisor/3)/2);r+=s;i+=o;r=Math.floor(r);i=Math.floor(i);n=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor/3),width:Math.floor(imageSrc.width/imageSrc.divisor/3),x:r,y:i})}else if(!drawImg){var u=Number(k)+1;r=Math.floor(r);i=Math.floor(i);n=new Kinetic.Text({fontFamily:"Liberation",height:Math.floor(75/3),width:Math.floor(75/3),fontSize:25,text:u,x:r,y:i,align:"center",fill:"black"})}imgLayer.add(n)}}}}}drawTiles();stage.draw()}function drawTiles(){for(var e=0;e<3;e++){for(var t=0;t<3;t++){var n=new Kinetic.Rect({x:Math.floor(225*e),y:Math.floor(225*t),width:225,height:225,stroke:"black",strokeWidth:4});backCellLayer.add(n)}}for(var e=0;e<9;e++){for(var t=0;t<9;t++){if(board.tiles[e][t].val=="*"){for(var r=0;r<3;r++){for(var i=0;i<3;i++){var n=new Kinetic.Rect({X:Math.floor(75*e+r*25),y:Math.floor(75*t+i*25),width:25,height:25,stroke:"black",strokeWidth:1});miniCellLayer.add(n)}}}var s,o;if(board.tiles[e][t].conf==3){s="green";o=4}else if(board.tiles[e][t].conf==2){s="yellow";o=4}else if(board.tiles[e][t].conf==1){s="red";o=4}else if(board.tiles[e][t].conf==0){s="black";o=1}var n=new Kinetic.Rect({x:Math.floor(75*e),y:Math.floor(75*t),width:75,height:75,stroke:s,strokeWidth:o});n.ix=e;n.iy=t;if(!board.tiles[e][t].perm){n.on("mouseover",function(){this.setStroke("blue");this.setStrokeWidth(4);this.moveToTop();stage.draw()});if(board.tiles[e][t].conf==3){n.on("mouseout",function(){this.setStroke("green");this.setStrokeWidth(4);this.moveToBottom();stage.draw()})}else if(board.tiles[e][t].conf==2){n.on("mouseout",function(){this.setStroke("yellow");this.setStrokeWidth(4);this.moveToBottom();stage.draw()})}else if(board.tiles[e][t].conf==1){n.on("mouseout",function(){this.setStroke("red");this.setStrokeWidth(4);this.moveToBottom();stage.draw()})}else{n.on("mouseout",function(){this.setStroke("black");this.setStrokeWidth(1);this.moveToBottom();stage.draw()})}}n.on("click tap",function(e){if(e.which==1)selectTile(this.ix,this.iy,true);else if(e.which==3)selectTile(this.ix,this.iy,false)});cellLayer.add(n)}}}function drawToolbar(){imgToolLayer.removeChildren();cellToolLayer.removeChildren();for(var e=0;e<9;e++){imageSrc=images[e];var t=0;var n=e;n*=75;var r;if(drawImg){r=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor),width:Math.floor(imageSrc.width/imageSrc.divisor),x:Math.floor(t+(75-imageSrc.width/imageSrc.divisor)/2),y:Math.floor(n+(75-imageSrc.height/imageSrc.divisor)/2)})}else if(!drawImg){r=new Kinetic.Text({x:t,y:n,fontFamily:"Liberation",text:e+1,fontSize:75,fill:"black",height:75,width:75,align:"center"})}imgToolLayer.add(r)}for(var e=0;e<9;e++){var i,s;if(e+1==selected){i="blue";s=4}else{i="black";s=1}var o=new Kinetic.Rect({x:0,y:Math.floor(e*75),width:75,height:75,stroke:i,strokeWidth:s});o.val=e+1;o.on("click",function(){selectTool(this.val);drawToolbar()});cellToolLayer.add(o)}var r=new Kinetic.Image({image:erase,height:75,width:75,x:75,y:375});imgToolLayer.add(r);var i,s;if("."==selected){i="blue";s=4}else{i="black";s=1}var o=new Kinetic.Rect({x:75,y:375,width:75,height:75,stroke:i,strokeWidth:s});o.val=".";o.on("click",function(){selectTool(this.val);drawToolbar()});cellToolLayer.add(o);numStage.draw();var r=new Kinetic.Image({image:zoomIn,height:75,width:75,x:75,y:225});imgToolLayer.add(r);var i,s;if("+"==selected){i="blue";s=4}else{i="black";s=1}var o=new Kinetic.Rect({x:75,y:225,width:75,height:75,stroke:i,strokeWidth:s});o.val="+";o.on("click",function(){selectTool(this.val);drawToolbar()});cellToolLayer.add(o);numStage.draw();var r=new Kinetic.Image({image:zoomOut,height:75,width:75,x:75,y:300});imgToolLayer.add(r);var i,s;if("-"==selected){i="blue";s=4}else{i="black";s=1}var o=new Kinetic.Rect({x:75,y:300,width:75,height:75,stroke:i,strokeWidth:s});o.val="-";o.on("click",function(){selectTool(this.val);drawToolbar()});cellToolLayer.add(o);numStage.draw()}function help(e){if(e){$("#help").modal({overlayClose:true})}else{$.modal.close()}}function Board(){this.tiles=[];this.solved=false;for(var e=0;e<9;e++){this.tiles[e]=[];for(var t=0;t<9;t++){if(unsolved[e][t]!="."){this.tiles[e][t]=new Tile(unsolved[e][t],solved[e][t],true)}else{this.tiles[e][t]=new Tile(unsolved[e][t],solved[e][t],false)}}}this.check=function(){var e=0;var t=0;for(var n=0;n<9;n++){for(var r=0;r<9;r++){if(this.tiles[n][r].val!=this.tiles[n][r].sol&&this.tiles[n][r].val!="."&&this.tiles[n][r].val!="*"){this.tiles[n][r].conf=1;t++}else if(this.tiles[n][r].val=="."||this.tiles[n][r].val=="*"){e++}else{if(!this.tiles[n][r].perm)this.tiles[n][r].conf=3}}}drawUnsolved();return{b:e,e:t}};this.solve=function(){for(var e=0;e<9;e++){for(var t=0;t<9;t++){if(!this.tiles[e][t].perm){this.tiles[e][t].val=this.tiles[e][t].sol;this.tiles[e][t].conf=3}}}drawUnsolved();this.checkWin()};this.checkWin=function(){var e=0;var t=0;for(var n=0;n<9;n++){for(var r=0;r<9;r++){if(this.tiles[n][r].val!=this.tiles[n][r].sol&&this.tiles[n][r].val!="."&&this.tiles[n][r].val!="*"){t++}else if(this.tiles[n][r].val=="."||this.tiles[n][r].val=="*"){e++}}}if(e==0&&t==0){$("#alerts").text("We have a winner!");this.solved=true}};this.set=function(e,t,n,r){if(!this.solved){this.tiles[e][t].set(n,r);this.checkWin()}}}function Tile(e,t,n){this.val=e;this.poss=[];this.sol=t;this.perm=n;this.conf=0;this.resetPoss=function(){for(var e=0;e<9;e++){this.poss[e]=false}};this.set=function(e,t){if(this.perm==false){if(e=="."){this.val=e;this.conf=0;this.resetPoss()}else if(!t){if(this.poss[e-1]){this.poss[e-1]=false;var n=true;for(i in this.poss){if(this.poss[i]){n=false;i=this.poss.length}}if(n){this.val=".";this.conf=0}}else{this.poss[e-1]=true;this.val="*";this.conf=2}}else{if(this.val==e){this.resetPoss();this.val=".";this.conf=0}else{this.val=e;this.conf=2;this.resetPoss()}}drawUnsolved()}}}function selectTile(e,t,n){if(selected=="+"||selected=="-"){zoom(e,t)}else{board.set(e,t,selected,n)}}function selectTool(e){selected=e}function zoom(e,t){var n=stage.getScale();if(selected=="+"){if(n.x<9){stage.setScale(n.x*3)}}else if(selected=="-"){if(n.x>1){stage.setScale(n.x/3)}}n=stage.getScale();if(n.x>1){if(n.x==3){stage.setX(-Math.floor(e/3)*3*75*n.x);stage.setY(-Math.floor(t/3)*3*75*n.x)}else{stage.setX(-e*75*n.x);stage.setY(-t*75*n.x)}}else{stage.setX(0);stage.setY(0)}stage.draw()}function checkErrors(){var e=board.check();var t="You have "+e.e+" error";if(e.e!=1){t+="s"}t+=" and "+e.b+" blank cell";if(e.b!=1){t+="s"}t+=".";$("#alerts").text(t)}function toggleDrawImg(){if(drawImg){drawImg=false;$("#toggleDrawImg").text("Switch to Images")}else{drawImg=true;$("#toggleDrawImg").text("Switch to Numbers")}drawUnsolved();drawToolbar()}function hint(){}function solvePuzzle(e){if(e){$.modal.close();board.solve()}else{$("#solvePuzzleConfirmation").modal({overlayClose:true})}}function viewAlbum(){var e=window.open(albumURL,"_blank");e.focus()}function shareAlbum(){var e="/share.html?h="+hash;var t=window.open(e,"_blank");t.focus()}var stage;var numStage;var imgLayer;var backCellLayer;var miniCellLayer;var cellLayer;var imgToolLayer;var cellToolLayer;var images=[];var loaded=0;var loadedPuzzle=false;var erase;var zoomIn;var zoomOut;var diff;var hash;var origin;var mess;var solved=[];var unsolved=[];var board;var selected=1;var drawImg=true;var albumURL;window.oncontextmenu=function(){return false};$(document).keypress(function(e){switch(Number(e.which)){case 48:selectTool(".");break;case 46:selectTool(".");break;case 49:selectTool(1);break;case 50:selectTool(2);break;case 51:selectTool(3);break;case 52:selectTool(4);break;case 53:selectTool(5);break;case 54:selectTool(6);break;case 55:selectTool(7);break;case 56:selectTool(8);break;case 57:selectTool(9);break;case 43:selectTool("+");break;case 61:selectTool("+");break;case 45:selectTool("-");break;case 95:selectTool("-");break}drawToolbar()});$(document).ready(function(){stage=new Kinetic.Stage({container:"gameStage",width:675,height:675});numStage=new Kinetic.Stage({container:"numStage",width:150,height:675});if(typeof specHash!=="undefined"){hash=specHash}else if(typeof getUrlVars()["h"]!=="undefined"){hash=getUrlVars()["h"]}else{hash="6EsqA"}if(typeof specOrigin!=="undefined"){origin=specOrigin}else if(typeof getUrlVars()["o"]!=="undefined"){origin=getUrlVars()["o"]}else{origin="i"}if(typeof specDiff!=="undefined"){diff=specDiff}else if(typeof getUrlVars()["d"]!=="undefined"){diff=getUrlVars()["d"]}else{diff=2}if(typeof specMess!=="undefined"){mess=specMess}else if(typeof getUrlVars()["pn"]!=="undefined"){if(getUrlVars()["pn"]==1){$.get("/_static/pn/pnm.txt",function(e){$("#announceWrapper").html(e);$("#announceWrapper").css("padding-bottom","20px")})}mess=-1}else{mess=-1}if(mess!=-1){$("#announceWrapper").html(mess);$("#announceWrapper").css("padding-bottom","20px")}if(origin=="i"){$("#albumShare").css("display","inline");getImgurImages(hash)}else if(origin=="fb"){getFBAlbum(hash)}erase=new Image;zoomIn=new Image;zoomOut=new Image;erase.src="/res/img/erase.png";zoomIn.src="/res/img/in.png";zoomOut.src="/res/img/out.png";erase.onload=new loadUtil;zoomIn.onload=new loadUtil;zoomOut.onload=new loadUtil;imgLayer=new Kinetic.Layer;backCellLayer=new Kinetic.Layer;miniCellLayer=new Kinetic.Layer;cellLayer=new Kinetic.Layer;imgToolLayer=new Kinetic.Layer;cellToolLayer=new Kinetic.Layer;numStage.add(imgToolLayer);numStage.add(cellToolLayer);stage.add(imgLayer);stage.add(backCellLayer);stage.add(miniCellLayer);stage.add(cellLayer);$.get("/res/php/puzzle.php",{d:diff}).done(function(e){var t=$.parseJSON(e);for(var n=0;n<9;n++){solved[n]=[];unsolved[n]=[];for(var r=0;r<9;r++){unsolved[n][r]=t.Unsolved.charAt(0);solved[n][r]=t.Solved.charAt(0);t.Unsolved=t.Unsolved.substr(1);t.Solved=t.Solved.substr(1)}}board=new Board;loadedPuzzle=true;if(loaded==12){drawUnsolved();drawToolbar()}})})