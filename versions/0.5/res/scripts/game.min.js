function nonPopState(){hash="undefined"!=typeof specHash?specHash:getUrlVars().h!==void 0?getUrlVars().h:"6EsqA",origin="undefined"!=typeof specOrigin?specOrigin:getUrlVars().o!==void 0?getUrlVars().o:"i",diff="undefined"!=typeof specDiff?specDiff:getUrlVars().d!==void 0?getUrlVars().d:2,"undefined"!=typeof specMess?mess=specMess:getUrlVars().pn!==void 0?(1==getUrlVars().pn&&(playNow=!0,$.get("/_static/pn/pnm.txt",function(e){$("#announceWrapperMess").append(e),$("#announceWrapper").css("padding-bottom","20px"),$("#announceWrapper").css("display","block")})),mess=-1):mess=-1;var e={h:hash,o:origin,d:diff};playNow?history.replaceState(e,"Play Imagedoku","game.html?o="+origin+"&h="+hash+"&d="+diff+"&pn=1"):history.replaceState(e,"Play Imagedoku","game.html?o="+origin+"&h="+hash+"&d="+diff),-1!=mess&&($("#announceWrapperMess").append(mess),$("#announceWrapper").css("padding-bottom","20px"),$("#announceWrapper").css("display","block")),"i"==origin?getImgurImages(hash):"fb"==origin&&getFBAlbum(hash)}function loadUtil(){loaded++,12==loaded&&(drawUnsolved(),drawToolbar())}function getImgurImages(e){$("#albumShare").css("display","inline"),document.title="Imagedoku - "+e+" (Imgur)",$.ajax({url:"https://api.imgur.com/3/album/"+e,type:"GET",dataType:"json",cache:!1,beforeSend:function(e){e.setRequestHeader("Authorization","Client-ID 60512304ac2e7ce")},success:function(e){if(albumURL=e.data.link,e.data.images.length>=9){$("#alerts").text("Loading...");for(var t=0;9>t;t++)images.push(new Image),images[t].src=e.data.images[t].link,images[t].index=t,images[t].onload=function(){loaded++,$("#alerts").append("."),this.divisor=this.width>this.height?this.width/75:this.height/75,12==loaded&&($("#alerts").text("Loaded!  Enjoy your game."),loadedPuzzle&&(drawUnsolved(),drawToolbar()))}}else $("#insufficientImagesError").modal()},error:function(){$("#imgurMalformedError").modal()}})}function getFBAlbum(e){$("#albumShare").css("display","none"),function(e){var t,i="facebook-jssdk",n=e.getElementsByTagName("script")[0];e.getElementById(i)||(t=e.createElement("script"),t.id=i,t.async=!0,t.src="//connect.facebook.net/en_US/all.js",n.parentNode.insertBefore(t,n))}(document),window.fbAsyncInit=function(){FB.init({appId:"154174584743698",channelUrl:"/res/misc/channel.html",status:!0,cookie:!0,xfbml:!0}),FB.getLoginStatus(function(t){"connected"===t.status?(FB.api("/"+e,function(e){document.title="Imagedoku - "+e.name+" (Facebook)",albumURL=e.link}),FB.api("/"+e+"/photos",function(e){getFBImages(e)})):"not_authorized"===t.status?$("#fbUnauthorizedError").modal():$("#fbLoggedOutError").modal()})}}function getFBAlbumFromStatePop(e){$("#albumShare").css("display","none"),"undefined"==typeof FB?getFBAlbum(e):(FB.api("/"+e,function(e){document.title="Imagedoku - "+e.name+" (Facebook)",albumURL=e.link}),FB.api("/"+e+"/photos",function(e){getFBImages(e)}))}function getFBImages(e){if(e.data.length>=9){$("#alerts").text("Loading...");for(var t=0;9>t;t++)images.push(new Image),images[t].src=e.data[t].source,images[t].index=t,images[t].onload=function(){loaded++,$("#alerts").append("."),this.divisor=this.width>this.height?this.width/75:this.height/75,12==loaded&&($("#alerts").text("Loaded!  Enjoy your game."),loadedPuzzle&&(drawUnsolved(),drawToolbar()))}}else $("#insufficientImagesError").modal()}function drawUnsolved(){stage.clear(),imgLayer.removeChildren(),cellLayer.removeChildren(),miniCellLayer.removeChildren(),backCellLayer.removeChildren();for(var e=0;9>e;e++)for(var t=0;9>t;t++)if("."!=board.tiles[e][t].val&&"*"!=board.tiles[e][t].val){imageSrc=images[board.tiles[e][t].val-1];var i;drawImg?i=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor),width:Math.floor(imageSrc.width/imageSrc.divisor),x:Math.floor(75*e+10*(Math.floor(e/3)+1)+2*(e+1)+2*e+(75-imageSrc.width/imageSrc.divisor)/2),y:Math.floor(75*t+10*(Math.floor(t/3)+1)+2*(t+1)+2*t+(75-imageSrc.height/imageSrc.divisor)/2)}):drawImg||(i=new Kinetic.Text({x:Math.floor(75*e)+10*(Math.floor(e/3)+1)+2*(e+1)+2*e,y:Math.floor(75*t)+10*(Math.floor(t/3)+1)+2*(t+1)+2*t,fontFamily:"Liberation",text:board.tiles[e][t].val,fontSize:75,fill:"black",height:75,width:75,align:"center"})),imgLayer.add(i)}else if("*"==board.tiles[e][t].val)for(k in board.tiles[e][t].poss)if(board.tiles[e][t].poss[k]){imageSrc=images[k];var n,s;n=75*e+10*(Math.floor(e/3)+1)+2*(e+1)+2*e,s=75*t+10*(Math.floor(t/3)+1)+2*(t+1)+2*t,n+=25*(k%3),s+=25*Math.floor(k/3);var i;if(drawImg){var o=Math.floor((25-imageSrc.width/imageSrc.divisor/3)/2),a=Math.floor((25-imageSrc.height/imageSrc.divisor/3)/2);n+=o,s+=a,n=Math.floor(n),s=Math.floor(s),i=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor/3),width:Math.floor(imageSrc.width/imageSrc.divisor/3),x:n,y:s})}else if(!drawImg){var r=Number(k)+1;n=Math.floor(n),s=Math.floor(s),i=new Kinetic.Text({fontFamily:"Liberation",height:Math.floor(25),width:Math.floor(25),fontSize:25,text:r,x:n,y:s,align:"center",fill:"black"})}imgLayer.add(i)}drawTiles(),stage.draw()}function drawTiles(){for(var e=0;3>e;e++)for(var t=0;3>t;t++){var i=new Kinetic.Rect({x:Math.floor(242*e)+5*(e+1),y:Math.floor(242*t)+5*(t+1),width:247,height:247,stroke:"black",strokeWidth:10});backCellLayer.add(i)}for(var e=0;9>e;e++)for(var t=0;9>t;t++){if("*"==board.tiles[e][t].val)for(var n=0;3>n;n++)for(var s=0;3>s;s++){var i=new Kinetic.Rect({X:Math.floor(75*e+25*n)+10*(Math.floor(e/3)+1)+2*(e+1)+2*e,y:Math.floor(75*t+25*s)+10*(Math.floor(t/3)+1)+2*(t+1)+2*t,width:25,height:25,stroke:"black",strokeWidth:1});miniCellLayer.add(i)}var o,a;3==board.tiles[e][t].conf?(o="green",a=4):2==board.tiles[e][t].conf?(o="yellow",a=4):1==board.tiles[e][t].conf?(o="red",a=4):0==board.tiles[e][t].conf&&(o="black",a=4);var i=new Kinetic.Rect({x:Math.floor(75*e)+10*(Math.floor(e/3)+1)+2*(e+1)+2*e,y:Math.floor(75*t)+10*(Math.floor(t/3)+1)+2*(t+1)+2*t,width:75,height:75,stroke:o,strokeWidth:4});i.ix=e,i.iy=t,i.on("mouseover",function(){mousedOver={x:this.ix,y:this.iy}}),board.tiles[e][t].perm||(i.on("mouseover",function(){this.setStroke("rgb(145, 253, 255)"),this.setStrokeWidth(4),this.moveToTop(),stage.draw()}),3==board.tiles[e][t].conf?i.on("mouseout",function(){this.setStroke("green"),this.setStrokeWidth(4),this.moveToBottom(),stage.draw()}):2==board.tiles[e][t].conf?i.on("mouseout",function(){this.setStroke("yellow"),this.setStrokeWidth(4),this.moveToBottom(),stage.draw()}):1==board.tiles[e][t].conf?i.on("mouseout",function(){this.setStroke("red"),this.setStrokeWidth(4),this.moveToBottom(),stage.draw()}):i.on("mouseout",function(){this.setStroke("black"),this.setStrokeWidth(4),this.moveToBottom(),stage.draw()})),i.on("click tap",function(e){1==e.which&&0==e.ctrlKey?selectTile(this.ix,this.iy,!0):(3==e.which||1==e.which&&1==e.ctrlKey)&&selectTile(this.ix,this.iy,!1)}),cellLayer.add(i)}}function drawToolbar(){imgToolLayer.removeChildren(),cellToolLayer.removeChildren();for(var e=0;9>e;e++){imageSrc=images[e];var t=2,i=e;i*=75,i+=4*e+2+20;var n;drawImg?n=new Kinetic.Image({image:imageSrc,height:Math.floor(imageSrc.height/imageSrc.divisor),width:Math.floor(imageSrc.width/imageSrc.divisor),x:Math.floor(t+(75-imageSrc.width/imageSrc.divisor)/2),y:Math.floor(i+(75-imageSrc.height/imageSrc.divisor)/2)}):drawImg||(n=new Kinetic.Text({x:t,y:i,fontFamily:"Liberation",text:e+1,fontSize:75,fill:"black",height:75,width:75,align:"center"})),imgToolLayer.add(n)}for(var e=0;9>e;e++){var s,o;e+1==selected?(s="rgb(145, 253, 255)",o=4):(s="black",o=4);var a=new Kinetic.Rect({x:2,y:Math.floor(75*e)+4*e+2+20,width:75,height:75,stroke:s,strokeWidth:o});a.val=e+1,a.on("click",function(){selectTool(this.val),drawToolbar()}),cellToolLayer.add(a)}var n=new Kinetic.Image({image:erase,height:75,width:75,x:81,y:417});imgToolLayer.add(n);var s,o;"."==selected?(s="rgb(145, 253, 255)",o=4):(s="black",o=4);var a=new Kinetic.Rect({x:81,y:417,width:75,height:75,stroke:s,strokeWidth:o});a.val=".",a.on("click",function(){selectTool(this.val),drawToolbar()}),cellToolLayer.add(a),numStage.draw();var n=new Kinetic.Image({image:zoomIn,height:75,width:75,x:81,y:259});imgToolLayer.add(n);var s,o;"+"==selected?(s="rgb(145, 253, 255)",o=4):(s="black",o=4);var a=new Kinetic.Rect({x:81,y:259,width:75,height:75,stroke:s,strokeWidth:o});a.val="+",a.on("click",function(){selectTool(this.val),drawToolbar()}),cellToolLayer.add(a),numStage.draw();var n=new Kinetic.Image({image:zoomOut,height:75,width:75,x:81,y:338});imgToolLayer.add(n);var s,o;"-"==selected?(s="rgb(145, 253, 255)",o=4):(s="black",o=4);var a=new Kinetic.Rect({x:81,y:338,width:75,height:75,stroke:s,strokeWidth:o});a.val="-",a.on("click",function(){selectTool(this.val),drawToolbar()}),cellToolLayer.add(a),numStage.draw()}function help(e){e?$("#help").modal({overlayClose:!0}):$.modal.close()}function Board(){this.tiles=[],this.solved=!1;for(var e=0;9>e;e++){this.tiles[e]=[];for(var t=0;9>t;t++)this.tiles[e][t]="."!=unsolved[e][t]?new Tile(unsolved[e][t],solved[e][t],!0):new Tile(unsolved[e][t],solved[e][t],!1)}this.check=function(){for(var e=0,t=0,i=0;9>i;i++)for(var n=0;9>n;n++)this.tiles[i][n].val!=this.tiles[i][n].sol&&"."!=this.tiles[i][n].val&&"*"!=this.tiles[i][n].val?(this.tiles[i][n].conf=1,t++):"."==this.tiles[i][n].val||"*"==this.tiles[i][n].val?e++:this.tiles[i][n].perm||(this.tiles[i][n].conf=3);return drawUnsolved(),{b:e,e:t}},this.solve=function(){for(var e=0;9>e;e++)for(var t=0;9>t;t++)this.tiles[e][t].perm||(this.tiles[e][t].val=this.tiles[e][t].sol,this.tiles[e][t].conf=3);drawUnsolved(),this.checkWin()},this.checkWin=function(){for(var e=0,t=0,i=0;9>i;i++)for(var n=0;9>n;n++)this.tiles[i][n].val!=this.tiles[i][n].sol&&"."!=this.tiles[i][n].val&&"*"!=this.tiles[i][n].val?t++:("."==this.tiles[i][n].val||"*"==this.tiles[i][n].val)&&e++;0==e&&0==t&&this.victoryDance(!0)},this.set=function(e,t,i,n){this.solved||(this.tiles[e][t].set(i,n),this.checkWin())},this.victoryDance=function(){if(this.dancing)window.clearInterval(victoryDance),victory.removeChildren(),victory.clear(),this.dancing=!1;else{$("#alerts").html('We have a winner!<br /><button type="button" onclick="board.victoryDance();">Toggle victory dance</button>'),this.solved=!0,victory=new Kinetic.Layer,victory.setClearBeforeDraw(!1),stage.add(victory);for(e in images){var t=new Kinetic.Image({x:Math.floor(675*Math.random()),y:-75,height:Math.floor(images[e].height/images[e].divisor),width:Math.floor(images[e].width/images[e].divisor),image:images[e]});t.dx=10*Math.random()-5,t.dy=10*Math.random()-5,victoryDancers.push(t),victory.add(t)}victoryDance=window.setInterval(function(){for(e in victoryDancers)victoryDancers[e].setX(victoryDancers[e].dx+victoryDancers[e].getX()),victoryDancers[e].dy+=.14,victoryDancers[e].setY(victoryDancers[e].dy+victoryDancers[e].getY()),-75>victoryDancers[e].getX()&&victoryDancers[e].setX(stage.getWidth()),victoryDancers[e].getX()>stage.getWidth()&&victoryDancers[e].setX(-75),victoryDancers[e].getY()>stage.getHeight()&&(victoryDancers[e].setY(-75),victoryDancers[e].dy=10*Math.random()-5);victory.draw()},33),this.dancing=!0}},this.dancing=!1}function Tile(e,t,n){this.val=e,this.poss=[],this.sol=t,this.perm=n,this.conf=0,this.resetPoss=function(){for(var e=0;9>e;e++)this.poss[e]=!1},this.set=function(e,t){if(0==this.perm){if("."==e)this.val=e,this.conf=0,this.resetPoss();else if(t)this.val==e?(this.resetPoss(),this.val=".",this.conf=0):(this.val=e,this.conf=2,this.resetPoss());else if(this.poss[e-1]){this.poss[e-1]=!1;var n=!0;for(i in this.poss)this.poss[i]&&(n=!1,i=this.poss.length);n&&(this.val=".",this.conf=0)}else this.poss[e-1]=!0,this.val="*",this.conf=2;drawUnsolved()}}}function selectTile(e,t,i){"+"==selected?zoom(e,t,!0):"-"==selected?zoom(e,t,!1):board.set(e,t,selected,i)}function selectTool(e){selected=e}function zoom(e,t,i){var n=stage.getScale();i?9>n.x&&stage.setScale(3*n.x):i||n.x>1&&stage.setScale(n.x/3),n=stage.getScale(),n.x>1?3==n.x?(stage.setX(75*3*-Math.floor(e/3)*n.x-75*Math.floor(e/3)),stage.setY(75*3*-Math.floor(t/3)*n.x-75*Math.floor(t/3)),0==Math.floor(e/3)?stage.setX(stage.getX()-10):2==Math.floor(e/3)&&stage.setX(stage.getX()+10),0==Math.floor(t/3)?stage.setY(stage.getY()-10):2==Math.floor(t/3)&&stage.setY(stage.getY()+10)):(stage.setX(-79*9*e-79+-10*9*Math.floor(e/3)+10),stage.setY(-79*9*t-79+-10*9*Math.floor(t/3)+10)):(stage.setX(0),stage.setY(0)),stage.draw()}function checkErrors(){var e=board.check(),t="You have "+e.e+" error";1!=e.e&&(t+="s"),t+=" and "+e.b+" blank cell",1!=e.b&&(t+="s"),t+=".",$("#alerts").text(t)}function toggleDrawImg(){drawImg?(drawImg=!1,$("#toggleDrawImg").text("Switch to Images")):(drawImg=!0,$("#toggleDrawImg").text("Switch to Numbers")),drawUnsolved(),drawToolbar()}function hint(){}function solvePuzzle(e){e?($.modal.close(),board.solve()):$("#solvePuzzleConfirmation").modal({overlayClose:!0})}function viewAlbum(){var e=window.open(albumURL,"_blank");e.focus()}function shareAlbum(){var e="/share.html?h="+hash,t=window.open(e,"_blank");t.focus()}function openCheckpoints(){$("#checkpoints").html("");for(i in checkpoints){var e=JSON.parse(checkpoints[i]);$("#checkpoints").prepend(drawCheckpoint(e,i))}$("#checkpointHolder").modal({overlayClose:!0,onShow:function(){$("#simplemodal-container").css("height","auto"),$("#simplemodal-container").css("width","auto")},onClose:function(){selectedCP=null,$.modal.close()},autoResize:!0})}function setCheckpoint(){checkpoints.push(JSON.stringify(board))}function drawCheckpoint(e,t){var i='<div class="cpHolder" id="'+t+'" onclick="selectCP('+t+');">';i+='<table class="cp">';for(var n=0;9>n;n++){i+='<tr class="cp">';for(var s=0;9>s;s++)i+='<td class="cp',0==n||3==n||6==n?i+=" outlineTop":(2==n||5==n||8==n)&&(i+=" outlineBot"),0==s||3==s||6==s?i+=" outlineLeft":(2==s||5==s||8==s)&&(i+=" outlineRight"),i+='">'+e.tiles[s][n].val+"</td>";i+="</tr>"}return i+="</table>",i+="</div>"}function selectCP(e){null!=selectedCP&&$("#"+selectedCP).css("background-color","transparent"),selectedCP=e,$("#"+selectedCP).css("background-color","rgb(145, 253, 255)")}function retrieveCP(){var e=JSON.parse(checkpoints[selectedCP]);for(i in board.tiles)for(j in board.tiles)board.tiles[i][j].val=e.tiles[i][j].val,board.tiles[i][j].poss=e.tiles[i][j].poss,board.tiles[i][j].sol=e.tiles[i][j].sol,board.tiles[i][j].perm=e.tiles[i][j].perm,board.tiles[i][j].conf=e.tiles[i][j].conf;board.solved=e.solved,$.modal.close(),drawUnsolved()}function deleteCP(){null!=selectedCP&&checkpoints.splice(selectedCP,1),$("#checkpoints").html(""),selectedCP=null;for(i in checkpoints){var e=JSON.parse(checkpoints[i]);$("#checkpoints").prepend(drawCheckpoint(e,i))}}function hideAnnounce(){$("#announceWrapper").slideUp()}function change(){$("input[name=difficulty]:eq("+(diff-1)+")","#changeForm").attr("checked","checked"),$("#options").modal({overlayClose:!0,onShow:function(){$("#simplemodal-container").css("height","auto"),$("#simplemodal-container").css("width","auto")},autoResize:!0}),$("#imgurinput").keyup(function(e){13==e.keyCode&&changeAlbum()})}function changeAlbum(){loaded-=9,hash=parseImgurURL($("#imgurinput").val());var e={h:hash,o:"i",d:diff};history.pushState(e,"Play Imagedoku","game.html?o=i&h="+hash+"&d="+diff),$.modal.close(),$("#alerts").text("Loading..."),getImgurImages(hash)}function changeDiff(){window.location="/game.html?o="+origin+"&h="+hash+"&d="+getDiff()}function getDiff(){return $.cookie("diff",$("input[name=difficulty]:checked","#changeForm").val(),{expires:999,path:"/"}),$("input[name=difficulty]:checked","#changeForm").val()}var stage,numStage,imgLayer,backCellLayer,miniCellLayer,cellLayer,victory,imgToolLayer,cellToolLayer,images=[],loaded=0,loadedPuzzle=!1,victoryDancers=[],victoryDance,erase,zoomIn,zoomOut,diff,hash,origin,mess,playNow=!1,solved=[],unsolved=[],board,checkpoints=[],selected=1,drawImg=!0,albumURL,mousedOver={x:null,y:null},debug=!1;window.oncontextmenu=function(){return debug};var popped=!1;window.onpopstate=function(e){console.log(e),null!==e.state&&(popped=!0,loaded=3,hash=e.state.h,origin=e.state.o,diff=e.state.d,$("#alerts").text("Loading..."),"i"==origin?getImgurImages(hash):"fb"==origin&&getFBAlbumFromStatePop(hash))},$(document).keypress(function(e){switch(Number(e.which)){case 32:selectTool(".");break;case 48:selectTool(".");break;case 46:selectTool(".");break;case 49:selectTool(1);break;case 50:selectTool(2);break;case 51:selectTool(3);break;case 52:selectTool(4);break;case 53:selectTool(5);break;case 54:selectTool(6);break;case 55:selectTool(7);break;case 56:selectTool(8);break;case 57:selectTool(9);break;case 43:selectTool("+");break;case 61:selectTool("+");break;case 45:selectTool("-");break;case 95:selectTool("-")}drawToolbar()}),$(document).ready(function(){popped||nonPopState(),stage=new Kinetic.Stage({container:"gameStage",width:751,height:751}),numStage=new Kinetic.Stage({container:"numStage",width:158,height:751}),getUrlVars().debug!==void 0?1==getUrlVars().debug&&(debug=!0):debug=!1,erase=new Image,zoomIn=new Image,zoomOut=new Image,erase.src="/res/img/erase.png",zoomIn.src="/res/img/in.png",zoomOut.src="/res/img/out.png",erase.onload=new loadUtil,zoomIn.onload=new loadUtil,zoomOut.onload=new loadUtil,imgLayer=new Kinetic.Layer,backCellLayer=new Kinetic.Layer,miniCellLayer=new Kinetic.Layer,cellLayer=new Kinetic.Layer,imgToolLayer=new Kinetic.Layer,cellToolLayer=new Kinetic.Layer,numStage.add(imgToolLayer),numStage.add(cellToolLayer),stage.add(imgLayer),stage.add(backCellLayer),stage.add(miniCellLayer),stage.add(cellLayer);var e=function(e){stage.getMousePosition()&&(e.preventDefault(),null!=mousedOver.x&&null!=mousedOver.y&&(e.wheelDeltaY>0?zoom(mousedOver.x,mousedOver.y,!0):0>e.wheelDeltaY&&zoom(mousedOver.x,mousedOver.y,!1)))};document.addEventListener("mousewheel",e,!1),$.get("/res/py/puzzle.py",{d:diff}).done(function(e){var t=e.board;t=t.split("#");var i={};i.Solved=t[0],i.Unsolved=t[1];for(var n=0;9>n;n++){solved[n]=[],unsolved[n]=[];for(var s=0;9>s;s++)unsolved[n][s]=i.Unsolved.charAt(0),solved[n][s]=i.Solved.charAt(0),i.Unsolved=i.Unsolved.substr(1),i.Solved=i.Solved.substr(1),"_"==unsolved[n][s]&&(unsolved[n][s]=".")}board=new Board,checkpoints.push(JSON.stringify(board)),loadedPuzzle=!0,12==loaded&&(drawUnsolved(),drawToolbar())})});var selectedCP=null;